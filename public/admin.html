<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ… ê´€ë¦¬ì - ì‚°íƒ€ë¥¼ ë§Œë‚œ ìˆœê°„</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }
    .header {
      background: linear-gradient(135deg, #1a472a, #2d5016);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 {
      font-size: 24px;
    }
    .header-stats {
      display: flex;
      gap: 20px;
    }
    .stat-box {
      background: rgba(255,255,255,0.2);
      padding: 10px 20px;
      border-radius: 10px;
      text-align: center;
    }
    .stat-box .number {
      font-size: 24px;
      font-weight: bold;
    }
    .stat-box .label {
      font-size: 12px;
      opacity: 0.8;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .tab {
      padding: 12px 24px;
      background: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    .tab.active {
      background: #1a472a;
      color: white;
    }
    .tab:hover:not(.active) {
      background: #e9ecef;
    }
    .orders-table {
      background: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      background: #f8f9fa;
      font-weight: 600;
      color: #333;
    }
    tr:hover {
      background: #f8f9fa;
    }
    .status-badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .status-pending {
      background: #fff3cd;
      color: #856404;
    }
    .status-processing {
      background: #cce5ff;
      color: #004085;
    }
    .status-completed {
      background: #d4edda;
      color: #155724;
    }
    .status-failed {
      background: #f8d7da;
      color: #721c24;
    }
    .action-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      margin-right: 5px;
      transition: all 0.3s;
    }
    .btn-view {
      background: #e9ecef;
      color: #333;
    }
    .btn-process {
      background: #1a472a;
      color: white;
    }
    .btn-complete {
      background: #28a745;
      color: white;
    }
    .btn-download {
      background: #007bff;
      color: white;
    }
    .action-btn:hover {
      opacity: 0.8;
      transform: scale(1.05);
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-header h2 {
      font-size: 20px;
    }
    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }
    .order-detail {
      display: grid;
      gap: 15px;
    }
    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }
    .detail-label {
      color: #666;
    }
    .detail-value {
      font-weight: 600;
    }
    .photo-preview {
      width: 100%;
      max-height: 300px;
      object-fit: contain;
      border-radius: 10px;
      margin-top: 10px;
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    .empty-state .icon {
      font-size: 60px;
      margin-bottom: 20px;
    }
    .refresh-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #c41e3a;
      color: white;
      border: none;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(196,30,58,0.4);
      transition: all 0.3s;
    }
    .refresh-btn:hover {
      transform: scale(1.1);
    }
    .message-preview {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 8px;
      font-style: italic;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <header class="header">
    <h1>ğŸ… ì‚°íƒ€ë¥¼ ë§Œë‚œ ìˆœê°„ - ê´€ë¦¬ì</h1>
    <div class="header-stats">
      <div class="stat-box">
        <div class="number" id="totalOrders">0</div>
        <div class="label">ì´ ì£¼ë¬¸</div>
      </div>
      <div class="stat-box">
        <div class="number" id="pendingOrders">0</div>
        <div class="label">ëŒ€ê¸° ì¤‘</div>
      </div>
      <div class="stat-box">
        <div class="number" id="totalRevenue">â‚©0</div>
        <div class="label">ì´ ë§¤ì¶œ</div>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="tabs">
      <button class="tab active" data-status="all">ì „ì²´</button>
      <button class="tab" data-status="pending">â³ ëŒ€ê¸°</button>
      <button class="tab" data-status="processing">ğŸ¨ ì œì‘ì¤‘</button>
      <button class="tab" data-status="completed">âœ… ì™„ë£Œ</button>
      <button class="tab" data-status="failed">âŒ ì‹¤íŒ¨</button>
    </div>

    <div class="orders-table">
      <table>
        <thead>
          <tr>
            <th>ì£¼ë¬¸ë²ˆí˜¸</th>
            <th>ì•„ì´ ì´ë¦„</th>
            <th>íŒ¨í‚¤ì§€</th>
            <th>ê¸ˆì•¡</th>
            <th>ìƒíƒœ</th>
            <th>ì£¼ë¬¸ì‹œê°„</th>
            <th>ì•¡ì…˜</th>
          </tr>
        </thead>
        <tbody id="ordersBody">
          <tr>
            <td colspan="7">
              <div class="empty-state">
                <div class="icon">ğŸ“­</div>
                <p>ì•„ì§ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ì£¼ë¬¸ ìƒì„¸ ëª¨ë‹¬ -->
  <div class="modal" id="orderModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ğŸ“¦ ì£¼ë¬¸ ìƒì„¸</h2>
        <button class="close-btn" onclick="closeModal()">&times;</button>
      </div>
      <div class="order-detail" id="orderDetail">
        <!-- ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
      </div>
    </div>
  </div>

  <button class="refresh-btn" onclick="loadOrders()" title="ìƒˆë¡œê³ ì¹¨">ğŸ”„</button>

  <script>
    let allOrders = [];
    let currentFilter = 'all';

    // ì£¼ë¬¸ ëª©ë¡ ë¡œë“œ
    async function loadOrders() {
      try {
        const response = await fetch('/api/admin/orders');
        const data = await response.json();
        
        if (data.success) {
          allOrders = data.orders;
          renderOrders();
          updateStats();
        }
      } catch (error) {
        console.error('ì£¼ë¬¸ ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    }

    // í†µê³„ ì—…ë°ì´íŠ¸
    function updateStats() {
      const total = allOrders.length;
      const pending = allOrders.filter(o => o.status === 'pending' || o.status === 'paid').length;
      const revenue = allOrders
        .filter(o => o.status !== 'failed')
        .reduce((sum, o) => sum + (o.amount || 0), 0);

      document.getElementById('totalOrders').textContent = total;
      document.getElementById('pendingOrders').textContent = pending;
      document.getElementById('totalRevenue').textContent = 'â‚©' + revenue.toLocaleString();
    }

    // ì£¼ë¬¸ ëª©ë¡ ë Œë”ë§
    function renderOrders() {
      const tbody = document.getElementById('ordersBody');
      
      let filteredOrders = allOrders;
      if (currentFilter !== 'all') {
        filteredOrders = allOrders.filter(o => o.status === currentFilter);
      }

      if (filteredOrders.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7">
              <div class="empty-state">
                <div class="icon">ğŸ“­</div>
                <p>í•´ë‹¹í•˜ëŠ” ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤</p>
              </div>
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = filteredOrders.map(order => `
        <tr>
          <td><strong>${order.orderId || '-'}</strong></td>
          <td>${order.childName || '-'} ${order.childAge ? `(${order.childAge}ì„¸)` : ''}</td>
          <td>${order.packageName || order.package || '-'}</td>
          <td>â‚©${(order.amount || 0).toLocaleString()}</td>
          <td><span class="status-badge status-${order.status}">${getStatusText(order.status)}</span></td>
          <td>${formatDate(order.createdAt)}</td>
          <td>
            <button class="action-btn btn-view" onclick="viewOrder('${order.orderId}')">ìƒì„¸</button>
            ${order.status === 'paid' ? `<button class="action-btn btn-process" onclick="updateStatus('${order.orderId}', 'processing')">ì œì‘ì‹œì‘</button>` : ''}
            ${order.status === 'processing' ? `<button class="action-btn btn-complete" onclick="updateStatus('${order.orderId}', 'completed')">ì™„ë£Œ</button>` : ''}
          </td>
        </tr>
      `).join('');
    }

    // ìƒíƒœ í…ìŠ¤íŠ¸
    function getStatusText(status) {
      const texts = {
        'pending': 'â³ ê²°ì œëŒ€ê¸°',
        'paid': 'ğŸ’° ê²°ì œì™„ë£Œ',
        'processing': 'ğŸ¨ ì œì‘ì¤‘',
        'completed': 'âœ… ì™„ë£Œ',
        'failed': 'âŒ ì‹¤íŒ¨'
      };
      return texts[status] || status;
    }

    // ë‚ ì§œ í¬ë§·
    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleString('ko-KR', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // ì£¼ë¬¸ ìƒì„¸ ë³´ê¸°
    async function viewOrder(orderId) {
      const order = allOrders.find(o => o.orderId === orderId);
      if (!order) return;

      const detail = document.getElementById('orderDetail');
      detail.innerHTML = `
        <div class="detail-row">
          <span class="detail-label">ì£¼ë¬¸ë²ˆí˜¸</span>
          <span class="detail-value">${order.orderId}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">ìƒíƒœ</span>
          <span class="detail-value"><span class="status-badge status-${order.status}">${getStatusText(order.status)}</span></span>
        </div>
        <div class="detail-row">
          <span class="detail-label">ì•„ì´ ì´ë¦„</span>
          <span class="detail-value">${order.childName || '-'}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">ì•„ì´ ë‚˜ì´</span>
          <span class="detail-value">${order.childAge || '-'}ì„¸</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">íŒ¨í‚¤ì§€</span>
          <span class="detail-value">${order.packageName || order.package || '-'}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">ì¶”ê°€ ì˜µì…˜</span>
          <span class="detail-value">${order.bumpOffers?.join(', ') || 'ì—†ìŒ'}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">ê²°ì œ ê¸ˆì•¡</span>
          <span class="detail-value" style="color: #c41e3a; font-size: 18px;">â‚©${(order.amount || 0).toLocaleString()}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">ì£¼ë¬¸ ì‹œê°„</span>
          <span class="detail-value">${formatDate(order.createdAt)}</span>
        </div>
        ${order.message ? `
          <div>
            <span class="detail-label">ì‚°íƒ€ ë©”ì‹œì§€</span>
            <div class="message-preview">"${order.message}"</div>
          </div>
        ` : ''}
        ${order.photoPath ? `
          <div>
            <span class="detail-label">ì—…ë¡œë“œëœ ì‚¬ì§„</span>
            <img src="${order.photoPath}" class="photo-preview" alt="ì—…ë¡œë“œëœ ì‚¬ì§„">
          </div>
        ` : ''}
      `;

      document.getElementById('orderModal').classList.add('active');
    }

    // ëª¨ë‹¬ ë‹«ê¸°
    function closeModal() {
      document.getElementById('orderModal').classList.remove('active');
    }

    // ìƒíƒœ ì—…ë°ì´íŠ¸
    async function updateStatus(orderId, newStatus) {
      try {
        const response = await fetch(`/api/admin/orders/${orderId}/status`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: newStatus })
        });
        
        const data = await response.json();
        if (data.success) {
          loadOrders();
        } else {
          alert('ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + data.message);
        }
      } catch (error) {
        alert('ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
      }
    }

    // íƒ­ í´ë¦­
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentFilter = tab.dataset.status;
        renderOrders();
      });
    });

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    document.getElementById('orderModal').addEventListener('click', (e) => {
      if (e.target.classList.contains('modal')) {
        closeModal();
      }
    });

    // ì´ˆê¸° ë¡œë“œ
    loadOrders();
    
    // 30ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
    setInterval(loadOrders, 30000);
  </script>
</body>
</html>

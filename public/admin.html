<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ… ê´€ë¦¬ì - ì‚°íƒ€ë¥¼ ë§Œë‚œ ìˆœê°„</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      min-height: 100vh;
    }
    .header {
      background: linear-gradient(135deg, #1a472a, #2d5016);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header h1 { font-size: 24px; }
    .header-stats {
      display: flex;
      gap: 20px;
    }
    .stat-box {
      background: rgba(255,255,255,0.2);
      padding: 10px 20px;
      border-radius: 10px;
      text-align: center;
    }
    .stat-box .number { font-size: 24px; font-weight: bold; }
    .stat-box .label { font-size: 12px; opacity: 0.8; }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    .refresh-btn {
      background: #1a472a;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 20px;
    }
    .orders-table {
      background: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    table { width: 100%; border-collapse: collapse; }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }
    th { background: #f8f9fa; font-weight: 600; }
    tr:hover { background: #f8f9fa; }
    
    .status-badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-processing { background: #cce5ff; color: #004085; }
    .status-ready { background: #d4edda; color: #155724; }
    .status-completed { background: #d4edda; color: #155724; }
    
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      margin: 2px;
    }
    .btn-primary { background: #1a472a; color: white; }
    .btn-danger { background: #c41e3a; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    /* ëª¨ë‹¬ */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal.show { display: flex; }
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .form-group input[type="file"] {
      width: 100%;
      padding: 10px;
      border: 2px dashed #ddd;
      border-radius: 8px;
    }
    .upload-preview {
      margin-top: 10px;
    }
    .upload-preview img, .upload-preview video {
      max-width: 100%;
      border-radius: 8px;
    }
    .order-detail {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .order-detail p {
      margin: 5px 0;
    }
    .copy-btn {
      background: #6c757d;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 11px;
    }
    .prompt-box {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 8px;
      font-size: 12px;
      margin: 10px 0;
      max-height: 100px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ… ì‚°íƒ€ë¥¼ ë§Œë‚œ ìˆœê°„ - ê´€ë¦¬ì</h1>
    <div class="header-stats">
      <div class="stat-box">
        <div class="number" id="totalOrders">0</div>
        <div class="label">ì´ ì£¼ë¬¸</div>
      </div>
      <div class="stat-box">
        <div class="number" id="pendingOrders">0</div>
        <div class="label">ì œì‘ ëŒ€ê¸°</div>
      </div>
      <div class="stat-box">
        <div class="number" id="totalRevenue">â‚©0</div>
        <div class="label">ì´ ë§¤ì¶œ</div>
      </div>
    </div>
  </div>

  <div class="container">
    <button class="refresh-btn" onclick="loadOrders()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
    
    <div class="orders-table">
      <table>
        <thead>
          <tr>
            <th>ì£¼ë¬¸ë²ˆí˜¸</th>
            <th>ì•„ì´ ì´ë¦„</th>
            <th>íŒ¨í‚¤ì§€</th>
            <th>ê¸ˆì•¡</th>
            <th>ìƒíƒœ</th>
            <th>ì£¼ë¬¸ì‹œê°„</th>
            <th>ê´€ë¦¬</th>
          </tr>
        </thead>
        <tbody id="ordersBody">
          <tr>
            <td colspan="7" style="text-align: center; padding: 40px;">
              ë¡œë”© ì¤‘...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ì—…ë¡œë“œ ëª¨ë‹¬ -->
  <div class="modal" id="uploadModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      
      <div class="order-detail" id="modalOrderDetail">
        <!-- ì£¼ë¬¸ ì •ë³´ í‘œì‹œ -->
      </div>
      
      <form id="uploadForm" onsubmit="submitUpload(event)">
        <input type="hidden" id="uploadOrderId">
        
        <div class="form-group">
          <label>ğŸ“¸ ì‚¬ì§„ íŒŒì¼ (ìµœëŒ€ 5ì¥)</label>
          <input type="file" id="photoFiles" accept="image/*" multiple>
          <div class="upload-preview" id="photoPreview"></div>
        </div>
        
        <div class="form-group">
          <label>ğŸ¬ ì˜ìƒ íŒŒì¼ (ì„ íƒ)</label>
          <input type="file" id="videoFile" accept="video/*">
          <div class="upload-preview" id="videoPreview"></div>
        </div>
        
        <button type="submit" class="btn btn-success" style="width: 100%; padding: 15px; font-size: 16px;">
          âœ… ì—…ë¡œë“œ & ì™„ì„± ì²˜ë¦¬
        </button>
      </form>
    </div>
  </div>

  <!-- ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
  <div class="modal" id="detailModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ğŸ“‹ ì£¼ë¬¸ ìƒì„¸</h2>
        <button class="modal-close" onclick="closeDetailModal()">&times;</button>
      </div>
      <div id="detailContent"></div>
    </div>
  </div>

  <script>
    let orders = [];
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì£¼ë¬¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    document.addEventListener('DOMContentLoaded', loadOrders);
    
    async function loadOrders() {
      try {
        const response = await fetch('/api/admin/orders');
        const data = await response.json();
        orders = data.orders || [];
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        document.getElementById('totalOrders').textContent = data.stats?.total || orders.length;
        document.getElementById('pendingOrders').textContent = data.stats?.processing || 0;
        document.getElementById('totalRevenue').textContent = 'â‚©' + (data.stats?.revenue || 0).toLocaleString();
        
        renderOrders();
      } catch (error) {
        console.error('ì£¼ë¬¸ ë¡œë“œ ì˜¤ë¥˜:', error);
        document.getElementById('ordersBody').innerHTML = `
          <tr><td colspan="7" style="text-align: center; color: red;">
            ì˜¤ë¥˜: ${error.message}
          </td></tr>
        `;
      }
    }
    
    function renderOrders() {
      const tbody = document.getElementById('ordersBody');
      
      if (orders.length === 0) {
        tbody.innerHTML = `
          <tr><td colspan="7" style="text-align: center; padding: 40px;">
            ì•„ì§ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤
          </td></tr>
        `;
        return;
      }
      
      tbody.innerHTML = orders.map(order => `
        <tr>
          <td style="font-family: monospace; font-size: 12px;">
            ${order.orderId?.substring(0, 20)}...
          </td>
          <td><strong>${order.childName || '-'}</strong></td>
          <td>${order.packageName || order.packageId || '-'}</td>
          <td>â‚©${(order.totalPrice || 0).toLocaleString()}</td>
          <td>
            <span class="status-badge status-${order.status}">
              ${getStatusText(order.status)}
            </span>
          </td>
          <td>${formatDate(order.createdAt)}</td>
          <td>
            <button class="btn btn-primary" onclick="showDetail('${order.orderId}')">
              ìƒì„¸
            </button>
            ${order.status !== 'ready' && order.status !== 'completed' ? `
              <button class="btn btn-success" onclick="openUploadModal('${order.orderId}')">
                ì—…ë¡œë“œ
              </button>
            ` : `
              <span style="color: #28a745;">âœ… ì™„ë£Œ</span>
            `}
          </td>
        </tr>
      `).join('');
    }
    
    function getStatusText(status) {
      const statusMap = {
        'pending': 'â³ ê²°ì œëŒ€ê¸°',
        'processing': 'ğŸ¨ ì œì‘ì¤‘',
        'ready': 'âœ… ì™„ì„±',
        'completed': 'âœ… ì™„ë£Œ'
      };
      return statusMap[status] || status;
    }
    
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleString('ko-KR', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
    
    // ìƒì„¸ë³´ê¸°
    function showDetail(orderId) {
      const order = orders.find(o => o.orderId === orderId);
      if (!order) return;
      
      const prompt = generatePrompt(order);
      
      document.getElementById('detailContent').innerHTML = `
        <div class="order-detail">
          <p><strong>ì£¼ë¬¸ë²ˆí˜¸:</strong> ${order.orderId}</p>
          <p><strong>ì•„ì´ ì´ë¦„:</strong> ${order.childName || '-'}</p>
          <p><strong>ë‚˜ì´:</strong> ${order.childAge || '-'}</p>
          <p><strong>ë©”ì‹œì§€:</strong> ${order.parentMessage || '-'}</p>
          <p><strong>íŒ¨í‚¤ì§€:</strong> ${order.packageName || order.packageId}</p>
          <p><strong>ê¸ˆì•¡:</strong> â‚©${(order.totalPrice || 0).toLocaleString()}</p>
          <p><strong>ìƒíƒœ:</strong> ${getStatusText(order.status)}</p>
          <p><strong>ê²°ì œìƒíƒœ:</strong> ${order.paymentStatus || '-'}</p>
        </div>
        
        <h3>ğŸ“ ì´ë¯¸ì§€ ìƒì„± í”„ë¡¬í”„íŠ¸</h3>
        <div class="prompt-box">${prompt}</div>
        <button class="copy-btn" onclick="copyText(\`${prompt.replace(/`/g, '\\`')}\`)">
          ğŸ“‹ í”„ë¡¬í”„íŠ¸ ë³µì‚¬
        </button>
        
        <h3 style="margin-top: 20px;">ğŸ”— ê³ ê° ì¡°íšŒ ë§í¬</h3>
        <div class="prompt-box">${window.location.origin}/order?id=${order.orderId}</div>
        <button class="copy-btn" onclick="copyText('${window.location.origin}/order?id=${order.orderId}')">
          ğŸ“‹ ë§í¬ ë³µì‚¬
        </button>
      `;
      
      document.getElementById('detailModal').classList.add('show');
    }
    
    function closeDetailModal() {
      document.getElementById('detailModal').classList.remove('show');
    }
    
    function generatePrompt(order) {
      return `Create a photorealistic image of Santa Claus in a Korean living room, leaving gifts. 
Child's name: ${order.childName || 'Child'}
Style: Warm, magical Christmas atmosphere, soft lighting, realistic`;
    }
    
    function copyText(text) {
      navigator.clipboard.writeText(text).then(() => {
        alert('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
      });
    }
    
    // ì—…ë¡œë“œ ëª¨ë‹¬
    function openUploadModal(orderId) {
      const order = orders.find(o => o.orderId === orderId);
      if (!order) return;
      
      document.getElementById('uploadOrderId').value = orderId;
      document.getElementById('modalOrderDetail').innerHTML = `
        <p><strong>ì£¼ë¬¸ë²ˆí˜¸:</strong> ${order.orderId}</p>
        <p><strong>ì•„ì´ ì´ë¦„:</strong> ${order.childName || '-'}</p>
        <p><strong>íŒ¨í‚¤ì§€:</strong> ${order.packageName || order.packageId}</p>
      `;
      
      // ë¯¸ë¦¬ë³´ê¸° ì´ˆê¸°í™”
      document.getElementById('photoPreview').innerHTML = '';
      document.getElementById('videoPreview').innerHTML = '';
      document.getElementById('photoFiles').value = '';
      document.getElementById('videoFile').value = '';
      
      document.getElementById('uploadModal').classList.add('show');
    }
    
    function closeModal() {
      document.getElementById('uploadModal').classList.remove('show');
    }
    
    // íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°
    document.getElementById('photoFiles').addEventListener('change', function(e) {
      const preview = document.getElementById('photoPreview');
      preview.innerHTML = '';
      Array.from(e.target.files).forEach(file => {
        const img = document.createElement('img');
        img.src = URL.createObjectURL(file);
        img.style.maxWidth = '100px';
        img.style.margin = '5px';
        preview.appendChild(img);
      });
    });
    
    document.getElementById('videoFile').addEventListener('change', function(e) {
      const preview = document.getElementById('videoPreview');
      preview.innerHTML = '';
      if (e.target.files[0]) {
        const video = document.createElement('video');
        video.src = URL.createObjectURL(e.target.files[0]);
        video.controls = true;
        video.style.maxWidth = '100%';
        preview.appendChild(video);
      }
    });
    
    // ì—…ë¡œë“œ ì œì¶œ
    async function submitUpload(e) {
      e.preventDefault();
      
      const orderId = document.getElementById('uploadOrderId').value;
      const photoFiles = document.getElementById('photoFiles').files;
      const videoFile = document.getElementById('videoFile').files[0];
      
      if (photoFiles.length === 0 && !videoFile) {
        alert('ìµœì†Œ 1ê°œ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”');
        return;
      }
      
      const formData = new FormData();
      formData.append('orderId', orderId);
      
      Array.from(photoFiles).forEach(file => {
        formData.append('photos', file);
      });
      
      if (videoFile) {
        formData.append('video', videoFile);
      }
      
      try {
        const response = await fetch('/api/admin/upload', {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert('âœ… ì—…ë¡œë“œ ì™„ë£Œ! ê³ ê°ì´ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
          closeModal();
          loadOrders();
        } else {
          alert('ì˜¤ë¥˜: ' + (result.error || 'ì—…ë¡œë“œ ì‹¤íŒ¨'));
        }
      } catch (error) {
        console.error('ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
        alert('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
      }
    }
  </script>
</body>
</html>
